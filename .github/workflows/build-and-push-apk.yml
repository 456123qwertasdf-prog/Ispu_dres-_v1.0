# Build Flutter APK and push only public/lspu-emergency-response.apk to the repo.
#
# Required: Repo Settings -> Actions -> General -> Workflow permissions
#   -> choose "Read and write permissions" so GITHUB_TOKEN can push the APK commit.
#
# Required for auto version enforcement: add GitHub Secret SUPABASE_SERVICE_ROLE_KEY
# (Supabase -> Settings -> API -> service_role) so app_version is updated and old APKs are blocked.
#
# For in-app "Download and install" to work (no "App not installed"), add release signing secrets
# so CI uses the same keystore as your local release builds. See mobile_app/android/RELEASE_SIGNING.md.
# Optional: ANDROID_KEYSTORE_BASE64, ANDROID_KEYSTORE_PASSWORD, ANDROID_KEY_PASSWORD, ANDROID_KEY_ALIAS (recommended for in-app updates)
#
# Your commits: do NOT use [skip ci] so this workflow runs. The workflow's own commit uses [skip ci] to avoid a loop.
name: Build and push APK

on:
  workflow_dispatch:  # Run manually from Actions tab
  push:
    branches: [main]
    paths:
      - 'mobile_app/**'
      - 'public/**'
      - '.github/workflows/build-and-push-apk.yml'

jobs:
  build-and-push-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK platform 33, CMake, and NDK
        run: |
          yes | sdkmanager --licenses || true
          for i in 1 2 3 4 5; do
            sdkmanager "platforms;android-33" "build-tools;33.0.1" "cmake;3.22.1" "ndk;25.1.8937393" && break
            echo "Attempt $i failed (e.g. 502 from dl.google.com), retrying in 45s..."
            sleep 45
          done

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.2'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get
        working-directory: mobile_app

      - name: Bump patch version in pubspec.yaml (e.g. 1.3.0 -> 1.3.1)
        run: |
          VER=$(grep '^version:' mobile_app/pubspec.yaml | sed -n 's/version: *\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\).*/\1.\2.\3/p')
          MAJOR=$(echo "$VER" | cut -d. -f1)
          MINOR=$(echo "$VER" | cut -d. -f2)
          PATCH=$(echo "$VER" | cut -d. -f3)
          PATCH=$((PATCH + 1))
          NEW_VER="${MAJOR}.${MINOR}.${PATCH}"
          RUN_NUM="${{ github.run_number }}"
          sed -i "s/^version: .*/version: ${NEW_VER}+${RUN_NUM}/" mobile_app/pubspec.yaml
          echo "Bumped version to ${NEW_VER}+${RUN_NUM}"

      - name: Prepare release keystore (same key = in-app updates work)
        env:
          KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          if [ -z "$KEYSTORE_B64" ] || [ -z "$KEYSTORE_PASSWORD" ]; then
            echo "Release signing secrets not set; build will use debug signing."
            exit 0
          fi
          mkdir -p mobile_app/android/app
          echo "$KEYSTORE_B64" | base64 -d > mobile_app/android/app/upload-keystore.jks
          printf '%s\n' \
            "storePassword=$KEYSTORE_PASSWORD" \
            "keyPassword=$KEY_PASSWORD" \
            "keyAlias=$KEY_ALIAS" \
            "storeFile=app/upload-keystore.jks" \
            > mobile_app/android/key.properties

      - name: "Build APK (version keeps updating: run number used as build number)"
        run: |
          VER=$(grep '^version:' pubspec.yaml | sed -n 's/version: *\([0-9]*\.[0-9]*\.[0-9]*\).*/\1/p')
          flutter build apk --release --build-name="$VER" --build-number="${{ github.run_number }}"
        working-directory: mobile_app

      - name: Copy APK to public folder
        run: |
          cp mobile_app/build/app/outputs/flutter-apk/app-release.apk public/lspu-emergency-response.apk
          ls -la public/lspu-emergency-response.apk

      - name: Commit APK and bumped version, then push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git lfs install
          git add public/lspu-emergency-response.apk mobile_app/pubspec.yaml
          git status
          if git diff --staged --quiet; then
            echo "No APK or version changes to commit."
          else
            git commit -m "chore: build and push APK [skip ci]"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update app version in Supabase (required so old APKs are blocked)
        run: |
          VERSION=$(grep '^version:' mobile_app/pubspec.yaml | sed -n 's/version: *\([0-9]*\.[0-9]*\.[0-9]*\).*/\1/p')
          if [ -z "$VERSION" ]; then
            echo "Could not parse version from pubspec.yaml"
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "::error::SUPABASE_SERVICE_ROLE_KEY not set. Add it in GitHub Secrets (Supabase -> Settings -> API -> service_role) so app_version is updated and old APKs cannot be used."
            exit 1
          fi
          # APK URL: same repo/branch we just pushed (so "Download and install" gets this build)
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/public/lspu-emergency-response.apk"
          echo "Updating app_version to $VERSION, download_url=$DOWNLOAD_URL"
          curl -sS -f -X PATCH "https://hmolyqzbvxxliemclrld.supabase.co/rest/v1/app_version?platform=eq.android" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{\"min_version\": \"$VERSION\", \"latest_version\": \"$VERSION\", \"download_url\": \"$DOWNLOAD_URL\", \"updated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"
          echo "Done. app_version updated to $VERSION"
