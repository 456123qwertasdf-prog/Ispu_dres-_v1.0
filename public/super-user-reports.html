<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super User ‚Ä¢ Reports - LSPU Emergency Response System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/system-status.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/supabase@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        /* ‚îÄ‚îÄ Super-User Sidebar Theme ‚îÄ‚îÄ */
        .sidebar { background: linear-gradient(180deg, #0f172a 0%, #064e3b 100%) !important; }
        .nav-item.active { background: rgba(16,185,129,0.2) !important; color: #34d399 !important; border-left: 3px solid #10b981 !important; border-top: none !important; border-right: none !important; border-bottom: none !important; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-item:hover { background: rgba(16,185,129,0.1) !important; color: #a7f3d0 !important; border-left-color: rgba(16,185,129,0.4) !important; }
        .status-dot.online { background: #10b981 !important; box-shadow: 0 0 0 3px rgba(16,185,129,0.25) !important; }
        .user-avatar { background: rgba(16,185,129,0.25) !important; color: #34d399 !important; }
        .sidebar-header { border-bottom: 1px solid rgba(16,185,129,0.15) !important; }
        .system-status { padding: 10px 20px; border-bottom: 1px solid rgba(16,185,129,0.15); }
        .su-role-badge { display:inline-flex; align-items:center; gap:4px; font-size:0.65rem; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; background:rgba(16,185,129,0.2); color:#34d399; border:1px solid rgba(16,185,129,0.4); border-radius:9999px; padding:2px 8px; margin-top:4px; }
        .su-logout-btn { width:100%; padding:0.75rem 1rem; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); color:#fca5a5; border-radius:8px; font-size:0.875rem; font-weight:500; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; gap:0.5rem; }
        .su-logout-btn:hover { background:#EF4444 !important; border-color:#EF4444 !important; color:white !important; }
        .su-content-header { background:linear-gradient(135deg, #0f172a 0%, #064e3b 100%); color:white; padding:1.5rem 2rem; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.15); border-left:4px solid #10b981; margin-bottom:1.75rem; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem; }
        .su-content-header h1 { margin:0; font-size:1.5rem; font-weight:700; display:flex; align-items:center; gap:0.75rem; }
        .su-content-header h1 i { color:#34d399; }
        .su-content-header p { margin:0.4rem 0 0 0; font-size:0.875rem; opacity:0.8; }

        /* Modal */
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); display:flex; justify-content:center; align-items:center; z-index:10000; backdrop-filter:blur(4px); }
        .modal.hidden { display:none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        #viewReportModal { align-items:flex-start !important; overflow-y:auto !important; padding:2rem 1rem; }
        .modal-content { background:white; border-radius:12px; padding:0; max-width:600px; width:90%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { display:flex; justify-content:space-between; align-items:center; padding:1.5rem; border-bottom:1px solid #e5e7eb; }
        .modal-header h2 { margin:0; font-size:1.25rem; font-weight:600; color:#111827; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; color:#6b7280; padding:0.25rem; border-radius:4px; }
        .modal-close:hover { background:#f3f4f6; color:#374151; }

        /* Logout Modal */
        .logout-modal { position:fixed; top:0; left:0; width:100%; height:100%; z-index:10001; display:flex; align-items:center; justify-content:center; animation:fadeIn 0.2s ease; }
        .logout-modal.hidden { display:none; }
        .logout-modal-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); }
        .logout-modal-content { position:relative; background:white; border-radius:16px; padding:2rem; max-width:420px; width:90%; box-shadow:0 20px 25px -5px rgba(0,0,0,0.3); animation:slideUp 0.3s ease; text-align:center; }
        .logout-modal-icon { width:64px; height:64px; margin:0 auto 1.5rem; background:linear-gradient(135deg,#fef2f2,#fee2e2); border-radius:50%; display:flex; align-items:center; justify-content:center; border:3px solid #fca5a5; }
        .logout-modal-icon i { font-size:2rem; color:#ef4444; }
        .logout-modal-title { font-size:1.5rem; font-weight:700; color:#111827; margin:0 0 0.75rem 0; }
        .logout-modal-message { font-size:0.9375rem; color:#6b7280; line-height:1.6; margin:0 0 1.75rem 0; }
        .logout-modal-buttons { display:flex; gap:0.75rem; justify-content:center; }
        .logout-modal-btn { padding:0.75rem 1.5rem; border-radius:8px; font-size:0.875rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; gap:0.5rem; border:2px solid transparent; }
        .logout-modal-btn.cancel { background:#f3f4f6; color:#374151; border-color:#e5e7eb; }
        .logout-modal-btn.cancel:hover { background:#e5e7eb; transform:translateY(-1px); }
        .logout-modal-btn.confirm { background:linear-gradient(135deg,#ef4444,#dc2626); color:white; border-color:#ef4444; box-shadow:0 2px 8px rgba(239,68,68,0.3); }
        .logout-modal-btn.confirm:hover { background:linear-gradient(135deg,#dc2626,#b91c1c); transform:translateY(-1px); }
        .logout-modal-btn:active { transform:translateY(0); }

        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{opacity:0;transform:translateY(20px) scale(0.95)} to{opacity:1;transform:translateY(0) scale(1)} }

        /* Hide emergencySystem alert elements */
        .alert, .alerts-container { display:none !important; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar" style="display:flex;flex-direction:column;">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="images/logolspu.jpg" alt="LSPU Logo"
                     style="width:50px;height:50px;object-fit:contain;border-radius:50%;border:2px solid rgba(52,211,153,0.6);display:block;">
                <div class="logo-text">
                    <h3 style="margin:0;font-size:15px;font-weight:700;color:white;">Super User</h3>
                    <p style="margin:2px 0 0 0;font-size:11px;color:rgba(255,255,255,0.6);">Emergency Response</p>
                    <span class="su-role-badge"><i class="bi bi-shield-star-fill"></i> Super User</span>
                </div>
            </div>
        </div>
        <div class="system-status">
            <div class="status-indicator">
                <span class="status-dot online"></span>
                <span style="font-size:0.8rem;color:rgba(255,255,255,0.75);">System Status: Online</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="super-user.html" class="nav-item"><i class="bi bi-house"></i> Dashboard</a>
            <a href="super-user-reports.html" class="nav-item active"><i class="bi bi-clipboard-data"></i> Recent Reports</a>
            <a href="super-user-early-warning.html" class="nav-item"><i class="bi bi-shield-exclamation"></i> Early Warning</a>
            <a href="super-user-map.html" class="nav-item"><i class="bi bi-map"></i> Map View</a>
            <a href="super-user-evacuation.html" class="nav-item"><i class="bi bi-shield-check"></i> Evacuation Guide</a>
            <a href="super-user-announcements.html" class="nav-item"><i class="bi bi-megaphone-fill"></i> Announcements</a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info-card">
                <div class="user-avatar">S</div>
                <div class="user-details">
                    <h4 id="suUserName" style="margin:0;font-size:0.875rem;font-weight:600;color:white;">Super User</h4>
                    <p style="margin:0;font-size:0.75rem;color:rgba(255,255,255,0.55);">LSPU Command</p>
                </div>
            </div>
            <button class="su-logout-btn" onclick="showLogoutConfirm()">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="su-content-header">
            <div>
                <h1><i class="bi bi-clipboard-data"></i> Emergency Reports</h1>
                <p>Manage and monitor emergency reports across the system.</p>
            </div>
            <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                <span style="background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.35);color:#34d399;border-radius:9999px;padding:0.3rem 0.85rem;font-size:0.75rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;">
                    <i class="bi bi-shield-star-fill"></i> Super User
                </span>
                <div style="text-align:right;">
                    <div style="font-size:0.75rem;color:rgba(255,255,255,0.7);">Logged in as</div>
                    <div style="font-weight:600;color:white;font-size:0.875rem;" id="userEmail">Super User</div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div class="admin-section active">
            <!-- Filters Card -->
            <div class="card">
                <div class="card-body">
                    <div class="mb-6">
                        <div class="flex flex-wrap gap-4 mb-4">
                            <div class="filter-group">
                                <label for="statusFilter" class="filter-label">Status:</label>
                                <select id="statusFilter" class="form-select" onchange="filterReports()">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="processing">Processing</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="classified">Classified</option>
                                    <option value="completed">Completed</option>
                                    <option value="resolved">Resolved</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="typeFilter" class="filter-label">Type:</label>
                                <select id="typeFilter" class="form-select" onchange="filterReports()">
                                    <option value="all">All Types</option>
                                    <option value="fire">Fire</option>
                                    <option value="flood">Flood</option>
                                    <option value="accident">Accident</option>
                                    <option value="medical">Medical</option>
                                    <option value="earthquake">Earthquake</option>
                                    <option value="storm">Storm</option>
                                    <option value="false_alarm">False Alarm</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="priorityFilter" class="filter-label">Priority:</label>
                                <select id="priorityFilter" class="form-select" onchange="filterReports()">
                                    <option value="all">All Priorities</option>
                                    <option value="1">Critical</option>
                                    <option value="2">High</option>
                                    <option value="3">Medium</option>
                                    <option value="4">Low</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="forceRefreshReports()" class="btn btn-primary">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Reports
                            </button>
                            <button onclick="syncAllCompletedStatuses()" class="btn btn-success">
                                <i class="bi bi-arrow-repeat"></i> Sync All
                            </button>
                            <button onclick="exportReports()" class="btn btn-secondary">
                                <i class="bi bi-download"></i> Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Reports Table -->
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Reporter</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-8">
                                        <div class="loading-spinner"></div>
                                        <p>Loading reports...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container">
                        <div class="pagination-info">
                            <span>Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalReports">0</span> reports</span>
                        </div>
                        <div class="pagination-controls">
                            <button class="btn btn-sm btn-outline" onclick="previousPage()" id="prevBtn" disabled>
                                <i class="bi bi-chevron-left"></i> Previous
                            </button>
                            <div class="page-numbers" id="pageNumbers"></div>
                            <button class="btn btn-sm btn-outline" onclick="nextPage()" id="nextBtn" disabled>
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- end .main-content -->
</div><!-- end .dashboard-container -->

<!-- View Report Modal -->
<div id="viewReportModal" class="modal hidden" style="display:none;position:fixed;inset:0;z-index:1000;align-items:flex-start;justify-content:center;background:rgba(0,0,0,0.5);overflow-y:auto;padding:2rem 1rem;">
    <div style="background:white;border-radius:12px;width:100%;max-width:1100px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;margin:auto;">
        <div style="background:linear-gradient(135deg,#059669 0%,#10b981 100%);color:white;padding:1.25rem 1.5rem;display:flex;justify-content:space-between;align-items:center;">
            <div>
                <h2 id="vrTitle" style="margin:0;font-size:1.2rem;font-weight:700;">Report Details</h2>
                <p style="margin:0.25rem 0 0;font-size:0.8rem;opacity:0.85;">Emergency Report ‚Äî Super User View</p>
            </div>
            <button onclick="closeViewModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
        </div>
        <div id="vrBody" style="padding:1.5rem;"></div>
    </div>
</div>

<!-- Edit Report Modal -->
<div id="editReportModal" style="display:none;position:fixed;inset:0;z-index:1050;background:rgba(0,0,0,0.55);align-items:flex-start;justify-content:center;overflow-y:auto;padding:2rem 1rem;">
    <div style="background:white;border-radius:12px;width:100%;max-width:860px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;margin:auto;">
        <div style="background:linear-gradient(135deg,#059669 0%,#10b981 100%);color:white;padding:1.25rem 1.5rem;display:flex;justify-content:space-between;align-items:center;">
            <div>
                <h2 id="erTitle" style="margin:0;font-size:1.2rem;font-weight:700;"><i class="bi bi-pencil-square"></i> Edit Emergency Report</h2>
                <p style="margin:0.25rem 0 0;font-size:0.8rem;opacity:0.85;">Update and manage emergency report information</p>
            </div>
            <button onclick="closeEditModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
        </div>
        <form id="erForm" style="padding:1.5rem;" onsubmit="event.preventDefault(); saveEditReport();">
            <!-- Emergency Information -->
            <div style="background:#f9fafb;border-radius:8px;padding:1.25rem;margin-bottom:1.25rem;border:1px solid #e5e7eb;">
                <h3 style="margin:0 0 1rem;font-size:0.95rem;font-weight:700;color:#065f46;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-exclamation-triangle"></i> Emergency Information</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Emergency Type</label>
                        <select id="er_type" style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;color:#1f2937;background:white;">
                            <option value="fire">üî• Fire Emergency</option>
                            <option value="flood">üåä Flood Emergency</option>
                            <option value="accident">üöó Traffic Accident</option>
                            <option value="medical">üè• Medical Emergency</option>
                            <option value="earthquake">üåç Earthquake</option>
                            <option value="storm">‚õàÔ∏è Storm</option>
                            <option value="false_alarm">üö´ False Alarm</option>
                            <option value="other">‚ö†Ô∏è Other Emergency</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Status</label>
                        <select id="er_status" style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;color:#1f2937;background:white;">
                            <option value="pending">‚è≥ Pending</option>
                            <option value="processing">üîÑ Processing</option>
                            <option value="classified">üìã Classified</option>
                            <option value="assigned">üë∑ Assigned</option>
                            <option value="in-progress">üöÄ In Progress</option>
                            <option value="completed">‚úÖ Completed</option>
                            <option value="cancelled">‚ùå Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Priority Level</label>
                        <select id="er_priority" style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;color:#1f2937;background:white;">
                            <option value="1">üî¥ Critical (1)</option>
                            <option value="2">üü† High (2)</option>
                            <option value="3">üü° Medium (3)</option>
                            <option value="4">üü¢ Low (4)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Severity</label>
                        <select id="er_severity" style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;color:#1f2937;background:white;">
                            <option value="LOW">üü¢ Low</option>
                            <option value="MEDIUM">üü° Medium</option>
                            <option value="HIGH">üü† High</option>
                            <option value="CRITICAL">üî¥ Critical</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- Reporter Information -->
            <div style="background:#f9fafb;border-radius:8px;padding:1.25rem;margin-bottom:1.25rem;border:1px solid #e5e7eb;">
                <h3 style="margin:0 0 1rem;font-size:0.95rem;font-weight:700;color:#065f46;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-person"></i> Reporter Information</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Reporter Name</label>
                        <input type="text" id="er_reporter_name" placeholder="Enter reporter's full name" style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Reporter UID</label>
                        <input type="text" id="er_reporter_uid" placeholder="Reporter unique identifier" style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;box-sizing:border-box;">
                    </div>
                </div>
            </div>
            <!-- Location & Description -->
            <div style="background:#f9fafb;border-radius:8px;padding:1.25rem;margin-bottom:1.25rem;border:1px solid #e5e7eb;">
                <h3 style="margin:0 0 1rem;font-size:0.95rem;font-weight:700;color:#065f46;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-geo-alt"></i> Location & Description</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Location Address</label>
                        <input type="text" id="er_location" placeholder="Enter exact location address" style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Emergency Description</label>
                        <textarea id="er_message" rows="3" placeholder="Provide detailed description..." style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;resize:vertical;box-sizing:border-box;"></textarea>
                    </div>
                </div>
            </div>
            <!-- Response & Additional Info -->
            <div style="background:#f9fafb;border-radius:8px;padding:1.25rem;margin-bottom:1.25rem;border:1px solid #e5e7eb;">
                <h3 style="margin:0 0 1rem;font-size:0.95rem;font-weight:700;color:#065f46;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-clock"></i> Response & Additional Information</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Expected Response Time</label>
                        <select id="er_response_time" style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;color:#1f2937;background:white;">
                            <option value="15 minutes">‚ö° 15 minutes (Critical)</option>
                            <option value="30 minutes">üö® 30 minutes (High)</option>
                            <option value="60 minutes">‚è∞ 60 minutes (Standard)</option>
                            <option value="2 hours">üïê 2 hours (Low)</option>
                            <option value="4 hours">üïë 4 hours (Non-urgent)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">AI Analysis Notes</label>
                        <textarea id="er_ai_analysis" rows="2" placeholder="AI analysis or insights..." style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;resize:vertical;box-sizing:border-box;"></textarea>
                    </div>
                    <div>
                        <label style="display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.35rem;">Recommendations</label>
                        <textarea id="er_recommendations" rows="2" placeholder="One per line..." style="width:100%;padding:0.6rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;resize:vertical;box-sizing:border-box;"></textarea>
                    </div>
                </div>
            </div>
            <!-- Actions -->
            <div style="display:flex;gap:1rem;justify-content:flex-end;padding-top:0.5rem;">
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary btn-sm"><i class="bi bi-x-lg"></i> Cancel</button>
                <button type="submit" id="erSaveBtn" class="btn btn-success btn-sm"><i class="bi bi-check-lg"></i> Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Assign Responder Modal (from View Report) -->
<div id="assignResponderModal" style="display:none;position:fixed;inset:0;z-index:1100;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
    <div style="background:white;border-radius:12px;width:90%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;">
        <div style="background:linear-gradient(135deg,#059669,#10b981);color:white;padding:1.25rem 1.5rem;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:1.05rem;font-weight:700;"><i class="bi bi-person-plus"></i> Assign Responder(s)</h3>
            <button onclick="closeAssignResponderModalVR()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;">&times;</button>
        </div>
        <div style="padding:1.25rem;">
            <label style="font-weight:600;font-size:0.875rem;color:#374151;display:block;margin-bottom:0.5rem;">Select Responders (Multiple Selection)</label>
            <div id="vrResponderList" style="max-height:280px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;padding:0.5rem;">
                <div style="padding:1rem;text-align:center;color:#6b7280;">Loading responders...</div>
            </div>
            <p style="margin-top:0.5rem;font-size:0.75rem;color:#6b7280;">Select one or more responders to assign to this report.</p>
        </div>
        <div style="padding:1rem 1.25rem;border-top:1px solid #e5e7eb;display:flex;gap:0.75rem;justify-content:flex-end;">
            <button onclick="closeAssignResponderModalVR()" class="btn btn-secondary btn-sm">Cancel</button>
            <button onclick="confirmAssignResponderVR()" class="btn btn-success btn-sm"><i class="bi bi-person-plus"></i> Assign Responders</button>
        </div>
    </div>
</div>

<!-- Classification Correction Modal -->
<div id="correction-modal" class="modal hidden">
    <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
            <h2>Correct Classification</h2>
            <button class="modal-close" onclick="closeCorrectionModal()">&times;</button>
        </div>
        <form onsubmit="event.preventDefault(); submitCorrection();" style="padding:1.5rem;">
            <div class="form-group" style="margin-bottom:1rem;">
                <label class="form-label" style="display:block;margin-bottom:0.5rem;font-weight:500;color:#374151;">Current Classification</label>
                <div style="padding:0.75rem;background:#f3f4f6;border-radius:0.375rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span><strong>Type:</strong> <span id="current-type">-</span></span>
                        <span><strong>Confidence:</strong> <span id="current-confidence">-</span></span>
                    </div>
                </div>
            </div>
            <div class="form-group" style="margin-bottom:1rem;">
                <label class="form-label" style="display:block;margin-bottom:0.5rem;font-weight:500;color:#374151;">AI Analysis</label>
                <div id="ai-analysis-info" style="padding:0.75rem;background:#f3f4f6;border-radius:0.375rem;font-size:0.875rem;color:#6b7280;">Loading...</div>
            </div>
            <div class="form-group" style="margin-bottom:1rem;">
                <label class="form-label" for="corrected-type" style="display:block;margin-bottom:0.5rem;font-weight:500;color:#374151;">Correct Emergency Type *</label>
                <select id="corrected-type" class="form-input" required style="width:100%;padding:0.75rem;border:1px solid #d1d5db;border-radius:0.375rem;font-size:0.875rem;">
                    <option value="">Select correct type...</option>
                    <option value="flood">Flood</option>
                    <option value="accident">Accident</option>
                    <option value="fire">Fire</option>
                    <option value="medical">Medical</option>
                    <option value="earthquake">Earthquake</option>
                    <option value="storm">Storm</option>
                    <option value="false_alarm">False Alarm</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom:1rem;">
                <label class="form-label" style="display:block;margin-bottom:0.5rem;font-weight:500;color:#374151;">Issue Categories (Optional)</label>
                <div style="display:flex;flex-direction:column;gap:0.5rem;">
                    <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;"><input type="checkbox" name="issue-category" value="wrong-context"> Wrong context detected</label>
                    <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;"><input type="checkbox" name="issue-category" value="missing-keywords"> Missing keywords or visual indicators</label>
                    <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;"><input type="checkbox" name="issue-category" value="visual-misclassification"> Visual misclassification</label>
                    <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;"><input type="checkbox" name="issue-category" value="confusing-similarity"> Confusing similarity to another type</label>
                    <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;"><input type="checkbox" name="issue-category" value="low-confidence"> Low confidence classification error</label>
                </div>
            </div>
            <div class="form-group" style="margin-bottom:1rem;">
                <label class="form-label" for="corrected-description" style="display:block;margin-bottom:0.5rem;font-weight:500;color:#374151;">Corrected Description <span style="font-weight:normal;color:#6b7280;font-size:0.875rem;">(Optional)</span></label>
                <input type="text" id="corrected-description" class="form-input" placeholder="e.g., Fallen Tree, Fallen Branch, Pathway Blocked" style="width:100%;padding:0.75rem;border:1px solid #d1d5db;border-radius:0.375rem;font-size:0.875rem;" />
            </div>
            <div class="form-group" style="margin-bottom:1rem;">
                <label class="form-label" for="correction-reason" style="display:block;margin-bottom:0.5rem;font-weight:500;color:#374151;">Detailed Correction Reason * <span style="font-weight:normal;color:#6b7280;font-size:0.875rem;">(Min. 20 characters)</span></label>
                <textarea id="correction-reason" class="form-input" rows="5" required minlength="20" placeholder="Explain why the AI classification is incorrect..." style="width:100%;padding:0.75rem;border:1px solid #d1d5db;border-radius:0.375rem;font-size:0.875rem;font-family:inherit;"></textarea>
            </div>
            <div style="display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem;">
                <button type="button" onclick="closeCorrectionModal()" style="padding:0.75rem 1.5rem;background:#6b7280;color:white;border:none;border-radius:0.375rem;cursor:pointer;font-weight:500;">Cancel</button>
                <button type="submit" style="padding:0.75rem 1.5rem;background:#3b82f6;color:white;border:none;border-radius:0.375rem;cursor:pointer;font-weight:500;">Submit Correction</button>
            </div>
        </form>
    </div>
</div>

<!-- Logout Confirmation Modal -->
<div id="logoutModal" class="logout-modal hidden">
    <div class="logout-modal-overlay" onclick="closeLogoutModal()"></div>
    <div class="logout-modal-content">
        <div class="logout-modal-icon"><i class="bi bi-exclamation-triangle"></i></div>
        <h3 class="logout-modal-title">Confirm Logout</h3>
        <p class="logout-modal-message">Are you sure you want to logout? You'll need to sign in again to access the system.</p>
        <div class="logout-modal-buttons">
            <button class="logout-modal-btn cancel" onclick="closeLogoutModal()"><i class="bi bi-x-circle"></i> Cancel</button>
            <button class="logout-modal-btn confirm" onclick="confirmLogout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
        </div>
    </div>
</div>

<script>
    function escapeHtml(text) {
        const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
        return String(text || '').replace(/[&<>"']/g, m => map[m]);
    }

    function showToast(message, type = 'info') {
        document.querySelectorAll('.toast-notification').forEach(t => t.remove());
        const icons = { success:'<i class="bi bi-check-circle-fill"></i>', error:'<i class="bi bi-x-circle-fill"></i>', info:'<i class="bi bi-info-circle-fill"></i>', warning:'<i class="bi bi-exclamation-triangle-fill"></i>' };
        const colors = { success:'linear-gradient(135deg,#10b981,#059669)', error:'linear-gradient(135deg,#ef4444,#dc2626)', info:'linear-gradient(135deg,#3b82f6,#2563eb)', warning:'linear-gradient(135deg,#f59e0b,#d97706)' };
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.style.cssText = `position:fixed;top:20px;right:20px;min-width:280px;max-width:450px;padding:1rem 1.25rem;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,0.25);z-index:99999;display:flex;align-items:center;gap:0.75rem;background:${colors[type]||colors.info};color:white;font-weight:500;font-size:0.9rem;animation:slideInRight 0.3s ease;`;
        toast.innerHTML = `<span style="font-size:1.25rem;">${icons[type]||icons.info}</span><span style="flex:1;">${message}</span><button onclick="this.parentElement.remove()" style="background:none;border:none;color:white;cursor:pointer;font-size:1.1rem;padding:0;opacity:0.8;">&times;</button>`;
        document.body.appendChild(toast);
        setTimeout(() => { if (toast.parentElement) { toast.style.opacity='0'; toast.style.transform='translateX(100%)'; toast.style.transition='all 0.3s'; setTimeout(()=>toast.remove(),300); } }, 3000);
    }

    let currentPage = 1;
    const reportsPerPage = 10;
    let allReports = [];
    let filteredReports = [];
    let currentReportForCorrection = null;
    let currentReportId = null;
    let currentReportData = null;
    let availableResponders = [];
    let isEditMode = false;

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(a => a.remove());

            await window.emergencySystem.initialize();

            if (window.emergencySystem) {
                window.emergencySystem.showAlert = function () {};
                window.emergencySystem.showSuccess = function () {};
                window.emergencySystem.showError = function () {};
                window.emergencySystem.showInfo = function () {};
            }

            const userRole = window.emergencySystem.user?.user_metadata?.role;
            if (!window.emergencySystem.user || userRole !== 'super_user') {
                if (userRole === 'admin') {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'login.html';
                }
                return;
            }

            const email = window.emergencySystem.user?.email || '';
            if (email) document.getElementById('userEmail').textContent = email;

            const displayName = window.emergencySystem.user?.user_metadata?.full_name
                || (email ? email.split('@')[0] : 'Super User');
            const nameEl = document.getElementById('suUserName');
            if (nameEl) nameEl.textContent = displayName;

            await loadReports();
            await setupRealTimeUpdates();

            console.log('‚úÖ Super User reports page initialized');
        } catch (error) {
            console.error('‚ùå Error initializing super user reports page:', error);
        }
    });

    // ‚îÄ‚îÄ Real-time ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function setupRealTimeUpdates() {
        try {
            window.emergencySystem.supabase
                .channel('su-reports-page-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'reports' }, () => loadReports())
                .subscribe();

            window.emergencySystem.supabase
                .channel('su-reports-assignments-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'assignment' }, () => loadReports())
                .subscribe();

            setInterval(() => loadReports(), 30000);
        } catch (error) {
            console.error('‚ùå Failed to setup real-time updates:', error);
        }
    }

    // ‚îÄ‚îÄ Load Reports ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadReports() {
        try {
            showLoadingIndicator();
            const reports = await window.emergencySystem.getReports();
            allReports = reports || [];
            filteredReports = [...allReports];
            displayReports();
            updatePagination();
            hideLoadingIndicator();
        } catch (error) {
            console.error('Error loading reports:', error);
            hideLoadingIndicator();
        }
    }

    async function forceRefreshReports() {
        allReports = [];
        filteredReports = [];
        currentPage = 1;
        await loadReports();
    }

    // ‚îÄ‚îÄ Sync completed statuses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function syncAllCompletedStatuses() {
        try {
            const { data: completedAssignments, error: assignmentsError } = await window.emergencySystem.supabase
                .from('assignment').select('id,report_id,status,completed_at').eq('status', 'resolved').not('report_id', 'is', null);
            if (assignmentsError) { alert('Failed: ' + assignmentsError.message); return; }
            if (!completedAssignments.length) { alert('No completed assignments found.'); return; }

            const { data: reps, error: reportsError } = await window.emergencySystem.supabase
                .from('reports').select('id,status').in('id', completedAssignments.map(a => a.report_id));
            if (reportsError) { alert('Failed: ' + reportsError.message); return; }

            const toUpdate = completedAssignments
                .filter(a => reps.find(r => r.id === a.report_id && r.status !== 'completed'))
                .map(a => a.report_id);

            let ok = 0, fail = 0;
            for (const id of toUpdate) {
                const { error } = await window.emergencySystem.supabase.from('reports').update({ status: 'completed' }).eq('id', id);
                error ? fail++ : ok++;
            }
            await loadReports();
            alert(`Sync completed!\n‚úÖ Updated: ${ok}\n‚ùå Failed: ${fail}`);
        } catch (error) {
            alert('Sync failed: ' + error.message);
        }
    }

    // ‚îÄ‚îÄ Display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function displayReports() {
        const tbody = document.getElementById('reportsTableBody');
        if (!tbody) return;

        const start = (currentPage - 1) * reportsPerPage;
        const end = start + reportsPerPage;
        const pageReports = filteredReports.slice(start, end);

        if (!pageReports.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8"><p class="text-gray-500">No reports found</p></td></tr>';
            return;
        }

        tbody.innerHTML = pageReports.map(report => `
            <tr>
                <td class="font-mono text-sm">${report.id ? report.id.substring(0, 8) + '...' : 'N/A'}</td>
                <td>
                    <span class="badge badge-${report.type || 'other'}">${getEmergencyIcon(report.type)} ${(report.type || 'other').toUpperCase()}</span>
                </td>
                <td>${report.reporter_name || 'Anonymous'}</td>
                <td>
                    <a href="super-user-map.html?reportId=${report.id}" style="color:#3b82f6;text-decoration:none;cursor:pointer;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'" title="View on Map">
                        <i class="bi bi-geo-alt-fill"></i> ${report.location?.address || 'Location detected'}
                    </a>
                </td>
                <td><span class="badge badge-${report.status || 'pending'}">${(report.status || 'pending').toUpperCase()}</span></td>
                <td><span class="badge badge-priority-${report.priority || 4}">${getPriorityText(report.priority || 4)}</span></td>
                <td>${report.created_at ? new Date(report.created_at).toLocaleDateString() : 'N/A'}</td>
                <td>
                    <div class="action-buttons">
                        <button onclick="viewReport('${report.id}')" class="btn btn-sm btn-info" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${report.type ? `<button onclick="openCorrectionModalFromId('${report.id}')" class="btn btn-sm" style="background:#F59E0B;color:white;" title="Correct Classification">
                            <i class="bi bi-pencil-square"></i>
                        </button>` : ''}
                        <button onclick="editReport('${report.id}')" class="btn btn-sm btn-warning" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button onclick="archiveReport('${report.id}')" class="btn btn-sm btn-secondary" title="Archive">
                            <i class="bi bi-archive"></i>
                        </button>
                        <button onclick="deleteReport('${report.id}')" class="btn btn-sm btn-danger" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // ‚îÄ‚îÄ Filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function filterReports() {
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const priorityFilter = document.getElementById('priorityFilter').value;

        filteredReports = allReports.filter(report => {
            const statusMatch = statusFilter === 'all' || report.status === statusFilter;
            const typeMatch = typeFilter === 'all' || report.type === typeFilter;
            const priorityMatch = priorityFilter === 'all' || report.priority == priorityFilter;
            return statusMatch && typeMatch && priorityMatch;
        });

        currentPage = 1;
        displayReports();
        updatePagination();
    }

    // ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function viewReport(reportId) {
        currentReportId = reportId;
        const modal = document.getElementById('viewReportModal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        document.getElementById('vrBody').innerHTML = `<div style="text-align:center;padding:3rem;color:#6b7280;"><div class="spinner" style="width:2rem;height:2rem;border:3px solid #e5e7eb;border-top-color:#10b981;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem;"></div>Loading report details...</div>`;
        try {
            const report = await window.emergencySystem.getReportById(reportId);
            if (!report) { document.getElementById('vrBody').innerHTML = '<p style="color:#ef4444;padding:2rem;">Report not found.</p>'; return; }
            currentReportData = report;
            if (report.reporter_uid) {
                try {
                    const { data } = await window.emergencySystem.supabase.functions.invoke('get-users', { body: {} });
                    if (data?.users) {
                        const u = data.users.find(x => (x.user_id || x.id) === report.reporter_uid);
                        if (u) {
                            report.reporter_email = u.email || '';
                            report.reporter_student_number = u.student_number || u.studentNumber || '';
                            report.reporter_phone = u.phone || u.contactNumber || '';
                            report.reporter_full_name = u.name || u.full_name || report.reporter_name || '';
                        }
                    }
                } catch(_) {}
            }
            await populateViewModal(report, reportId);
        } catch(e) {
            document.getElementById('vrBody').innerHTML = `<p style="color:#ef4444;padding:2rem;">Failed to load: ${e.message}</p>`;
        }
    }

    async function populateViewModal(report, rId) {
        let locationText = 'Location not specified';
        if (report.location) {
            if (typeof report.location === 'string') {
                try { const l = JSON.parse(report.location); locationText = l.address || l.formatted_address || 'Location detected'; }
                catch(_) { locationText = report.location; }
            } else if (report.location.address) { locationText = report.location.address; }
            else if (report.location.formatted_address) { locationText = report.location.formatted_address; }
            else { locationText = 'Location detected'; }
        }
        const createdAt = report.created_at ? new Date(report.created_at).toLocaleString() : 'N/A';
        const updatedAt = report.last_update ? new Date(report.last_update).toLocaleString() : 'Never updated';
        let classification = report.corrected_description || report.ai_description || '';
        if (classification && classification.includes('-')) { const parts = classification.split('-').map(p=>p.trim()); if(parts.length>1) classification=parts.slice(1).join('-').trim(); }
        if (!classification) { classification = report.message || 'Not specified'; if(classification.length>50) classification=classification.substring(0,50)+'...'; }
        const rName = report.reporter_full_name || report.reporter_name || 'Anonymous';
        const rEmail = report.reporter_email || report.email || report.gmail || 'Not provided';
        const rStuNo = report.reporter_student_number || report.student_number || 'Not provided';
        const rPhone = report.reporter_phone || report.phone || report.contactNumber || 'Not provided';

        // image
        let imageUrl = report.image_url || report.photo_url || report.image || report.image_path || null;
        if (imageUrl && !/^https?:\/\//i.test(imageUrl)) {
            try { const p = window.emergencySystem?.supabase?.storage?.from('reports-images')?.getPublicUrl(imageUrl); if(p?.data?.publicUrl) imageUrl = p.data.publicUrl; } catch(_) {}
        }
        const imgHtml = imageUrl
            ? `<img src="${imageUrl}" alt="Report image" style="width:100%;max-width:280px;height:180px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;">`
            : `<div style="width:100%;max-width:280px;height:120px;background:#f3f4f6;border:2px dashed #d1d5db;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:0.85rem;">No image uploaded</div>`;

        // assignments
        let assignedText = 'Not assigned';
        try {
            const { data: asgn } = await window.emergencySystem.supabase.from('assignment').select('responder_id,status').eq('report_id', rId).eq('status','assigned');
            if (asgn && asgn.length > 0) {
                const resp = await window.emergencySystem.getResponders();
                assignedText = asgn.map(a => { const r = resp.find(x=>x.id===a.responder_id); return r?.name||`Responder ${a.responder_id.substring(0,8)}`; }).join(', ');
            }
        } catch(_) { assignedText = report.responder_name || 'Not assigned'; }

        // badge helpers
        const typeIcons = {fire:'üî•',flood:'üåä',accident:'üöó',medical:'üè•',earthquake:'üåç',storm:'‚õàÔ∏è',false_alarm:'üö´',other:'‚ö†Ô∏è'};
        const typeLabels = {false_alarm:'False Alarm',non_emergency:'Non-Emergency'};
        const t = report.type || 'other';
        const typeBadge = `<span style="display:inline-flex;align-items:center;gap:0.4rem;padding:0.3rem 0.75rem;border-radius:8px;font-weight:600;font-size:0.85rem;background:#f0fdf4;color:#059669;">${typeIcons[t]||'‚ö†Ô∏è'} ${(typeLabels[t]||(t.toUpperCase().replace('_',' ')))}</span>`;
        const statusColors = {pending:'#fef3c7|#d97706',processing:'#dbeafe|#2563eb',classified:'#fed7aa|#ea580c',assigned:'#e0e7ff|#7c3aed','in-progress':'#a7f3d0|#059669','in_progress':'#a7f3d0|#059669',completed:'#d1fae5|#047857',cancelled:'#f3f4f6|#6b7280'};
        const sc = (statusColors[report.status]||'#f3f4f6|#6b7280').split('|');
        const statusBadge = `<span style="padding:0.25rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:600;text-transform:uppercase;background:${sc[0]};color:${sc[1]};">${(report.status||'unknown').toUpperCase()}</span>`;
        const pColors = {'1':'#fee2e2|#dc2626','2':'#fef3c7|#d97706','3':'#dbeafe|#2563eb','4':'#f3f4f6|#6b7280'};
        const pc = (pColors[report.priority||4]||'#f3f4f6|#6b7280').split('|');
        const pLabels = {'1':'Critical','2':'High','3':'Medium','4':'Low'};
        const priorityBadge = `<span style="padding:0.25rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:600;background:${pc[0]};color:${pc[1]};">${pLabels[report.priority||4]||'Low'}</span>`;

        document.getElementById('vrTitle').textContent = `Report #${rId.substring(0,8).toUpperCase()}`;
        document.getElementById('vrBody').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1rem;">
            <div style="border:1px solid #e5e7eb;border-radius:0.5rem;overflow:hidden;">
                <div style="background:#f9fafb;padding:0.75rem 1rem;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-exclamation-triangle" style="color:#059669;"></i><strong style="font-size:0.9rem;">Emergency Information</strong></div>
                <div style="padding:1rem;display:grid;gap:0.6rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Type</span><div>${typeBadge}</div></div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Classification</span><div style="text-align:right;font-size:0.85rem;max-width:55%;">${escapeHtml(classification)}</div></div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Status</span><div>${statusBadge}</div></div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Priority</span><div>${priorityBadge}</div></div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Severity</span><span style="font-size:0.85rem;">${escapeHtml(report.severity||'LOW')}</span></div>
                </div>
            </div>
            <div style="border:1px solid #e5e7eb;border-radius:0.5rem;overflow:hidden;">
                <div style="background:#f9fafb;padding:0.75rem 1rem;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-person" style="color:#059669;"></i><strong style="font-size:0.9rem;">Reporter Information</strong></div>
                <div style="padding:1rem;display:grid;gap:0.6rem;">
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Name</span><span style="font-size:0.85rem;">${escapeHtml(rName)}</span></div>
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Email</span><span style="font-size:0.85rem;word-break:break-all;max-width:60%;text-align:right;">${escapeHtml(rEmail)}</span></div>
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Student No.</span><span style="font-size:0.85rem;">${escapeHtml(rStuNo)}</span></div>
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Contact</span><span style="font-size:0.85rem;">${escapeHtml(rPhone)}</span></div>
                </div>
            </div>
            <div style="border:1px solid #e5e7eb;border-radius:0.5rem;overflow:hidden;">
                <div style="background:#f9fafb;padding:0.75rem 1rem;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-geo-alt" style="color:#059669;"></i><strong style="font-size:0.9rem;">Location & Description</strong></div>
                <div style="padding:1rem;display:grid;gap:0.6rem;">
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Location</span><span style="font-size:0.85rem;text-align:right;max-width:60%;">${escapeHtml(locationText)}</span></div>
                    <div style="padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><div style="font-weight:600;font-size:0.85rem;color:#374151;margin-bottom:0.3rem;">Description</div><div style="font-size:0.85rem;color:#374151;">${escapeHtml(report.message||'No description provided')}</div></div>
                    <div style="padding:0.4rem 0;">${imgHtml}</div>
                </div>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem;">
            <div style="border:1px solid #e5e7eb;border-radius:0.5rem;overflow:hidden;">
                <div style="background:#f9fafb;padding:0.75rem 1rem;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-person-badge" style="color:#059669;"></i><strong style="font-size:0.9rem;">Assignment Information</strong></div>
                <div style="padding:1rem;display:grid;gap:0.6rem;">
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Assigned Responder</span><span style="font-size:0.85rem;color:${assignedText!=='Not assigned'?'#059669':'#6b7280'};text-align:right;max-width:55%;">${escapeHtml(assignedText)}</span></div>
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Assignment ID</span><span style="font-size:0.85rem;">${escapeHtml(String(report.assignment_id||'Not assigned'))}</span></div>
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Response Time</span><span style="font-size:0.85rem;">${escapeHtml(String(report.response_time||'Not specified'))}</span></div>
                </div>
            </div>
            <div style="border:1px solid #e5e7eb;border-radius:0.5rem;overflow:hidden;">
                <div style="background:#f9fafb;padding:0.75rem 1rem;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-clock-history" style="color:#059669;"></i><strong style="font-size:0.9rem;">Timestamps</strong></div>
                <div style="padding:1rem;display:grid;gap:0.6rem;">
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Created At</span><span style="font-size:0.85rem;">${createdAt}</span></div>
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Last Updated</span><span style="font-size:0.85rem;">${updatedAt}</span></div>
                </div>
            </div>
            ${report.ai_analysis ? `
            <div style="border:1px solid #e5e7eb;border-radius:0.5rem;overflow:hidden;">
                <div style="background:#f9fafb;padding:0.75rem 1rem;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:0.5rem;"><i class="bi bi-robot" style="color:#059669;"></i><strong style="font-size:0.9rem;">AI Analysis</strong></div>
                <div style="padding:1rem;display:grid;gap:0.6rem;">
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Analysis</span><span style="font-size:0.85rem;">${escapeHtml(report.ai_analysis)}</span></div>
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Confidence</span><span style="font-size:0.85rem;">${Math.round((report.ai_confidence||0)*100)}%</span></div>
                    <div style="display:flex;justify-content:space-between;padding:0.4rem 0;"><span style="font-weight:600;font-size:0.85rem;color:#374151;">Model</span><span style="font-size:0.85rem;">${escapeHtml(report.ai_model||'Unknown')}</span></div>
                </div>
            </div>` : '<div></div>'}
        </div>
        <div style="display:flex;gap:1rem;padding-top:1rem;border-top:1px solid #e5e7eb;flex-wrap:wrap;">
            <button onclick="showAssignResponderModal('${rId}')" class="btn btn-success btn-sm"><i class="bi bi-person-plus"></i> Assign Responder</button>
            <button onclick="closeViewModal();openCorrectionModalFromId('${rId}')" class="btn btn-warning btn-sm"><i class="bi bi-pencil-square"></i> Correct Classification</button>
            <button onclick="closeViewModal(); openEditModal('${rId}')" class="btn btn-sm" style="background:#3b82f6;color:white;border:none;cursor:pointer;"><i class="bi bi-pencil"></i> Edit Report</button>
            <button onclick="closeViewModal()" class="btn btn-secondary btn-sm"><i class="bi bi-x-lg"></i> Close</button>
        </div>`;
    }

    function closeViewModal() {
        const modal = document.getElementById('viewReportModal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }

    async function openEditModal(reportId) {
        currentReportId = reportId;
        const modal = document.getElementById('editReportModal');
        modal.style.display = 'flex';
        document.getElementById('erTitle').textContent = `‚úèÔ∏è Edit Report #${reportId.substring(0,8).toUpperCase()}`;
        document.getElementById('erSaveBtn').disabled = false;
        document.getElementById('erSaveBtn').textContent = '‚úî Save Changes';
        try {
            const report = await window.emergencySystem.getReportById(reportId);
            if (!report) { showToast('Report not found', 'error'); closeEditModal(); return; }
            currentReportData = report;
            // Populate fields
            document.getElementById('er_type').value = report.type || 'other';
            document.getElementById('er_status').value = report.status || 'pending';
            document.getElementById('er_priority').value = report.priority || 4;
            document.getElementById('er_severity').value = report.severity || 'LOW';
            document.getElementById('er_reporter_name').value = report.reporter_name || '';
            document.getElementById('er_reporter_uid').value = report.reporter_uid || '';
            let locationText = '';
            if (report.location) {
                if (typeof report.location === 'string') {
                    try { const l = JSON.parse(report.location); locationText = l.address || l.formatted_address || ''; } catch(_) { locationText = report.location; }
                } else { locationText = report.location.address || report.location.formatted_address || ''; }
            }
            document.getElementById('er_location').value = locationText;
            document.getElementById('er_message').value = report.message || '';
            document.getElementById('er_response_time').value = report.response_time || '60 minutes';
            document.getElementById('er_ai_analysis').value = report.ai_analysis || '';
            document.getElementById('er_recommendations').value = Array.isArray(report.recommendations) ? report.recommendations.join('\n') : (report.recommendations || '');
        } catch(e) { showToast('Failed to load report: ' + e.message, 'error'); closeEditModal(); }
    }

    function closeEditModal() {
        document.getElementById('editReportModal').style.display = 'none';
    }

    async function saveEditReport() {
        const saveBtn = document.getElementById('erSaveBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        try {
            const locationText = document.getElementById('er_location').value.trim();
            const updateData = {
                type: document.getElementById('er_type').value,
                status: document.getElementById('er_status').value,
                priority: parseInt(document.getElementById('er_priority').value),
                severity: document.getElementById('er_severity').value,
                reporter_name: document.getElementById('er_reporter_name').value,
                reporter_uid: document.getElementById('er_reporter_uid').value,
                message: document.getElementById('er_message').value,
                response_time: document.getElementById('er_response_time').value,
                ai_analysis: document.getElementById('er_ai_analysis').value,
                recommendations: document.getElementById('er_recommendations').value.split('\n').filter(r => r.trim()),
                last_update: new Date().toISOString()
            };
            if (locationText) { updateData.location = { address: locationText, formatted_address: locationText }; }
            const { error } = await window.emergencySystem.supabase.from('reports').update(updateData).eq('id', currentReportId);
            if (error) throw error;
            showToast('Report updated successfully!', 'success');
            closeEditModal();
            await loadReports();
        } catch(e) {
            showToast('Failed to save: ' + e.message, 'error');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save Changes';
        }
    }

    async function showAssignResponderModal(reportId) {
        currentReportId = reportId;
        const modal = document.getElementById('assignResponderModal');
        modal.style.display = 'flex';
        const list = document.getElementById('vrResponderList');
        list.innerHTML = '<div style="padding:1rem;text-align:center;color:#6b7280;">Loading responders...</div>';
        try {
            const responders = await window.emergencySystem.getResponders();
            let assignedIds = [];
            try {
                const { data } = await window.emergencySystem.supabase.from('assignment').select('responder_id').eq('report_id', reportId).eq('status','assigned');
                if (data) assignedIds = data.map(a => a.responder_id);
            } catch(_) {}
            const allResponderIds = (responders || []).map(r => r.id);
            let busyResponderIds = new Set();
            try {
                const { data: activeData } = await window.emergencySystem.supabase.from('assignment').select('responder_id, status').in('responder_id', allResponderIds);
                const activeStatuses = ['assigned', 'accepted', 'enroute', 'in_progress', 'on_scene'];
                busyResponderIds = new Set((activeData || []).filter(a => activeStatuses.includes(a.status)).map(a => a.responder_id));
            } catch(_) {}
            list.innerHTML = '';
            if (!responders || !responders.length) { list.innerHTML = '<div style="padding:1rem;text-align:center;color:#6b7280;">No responders available.</div>'; return; }
            window._lastAssignModalResponders = responders;
            const leaders = responders.filter(r => !r.leader_id);
            const teams = leaders.map(leader => ({
                leader,
                name: (leader.team_name && leader.team_name.trim()) ? leader.team_name.trim() : ('Team ' + (leader.name || 'Unnamed')),
                members: responders.filter(r => r.leader_id === leader.id)
            }));
            const ungrouped = responders.filter(r => r.leader_id && !leaders.find(l => l.id === r.leader_id));

            function addRow(r, isAssigned, isBusy, isMember) {
                const row = document.createElement('div');
                row.style.cssText = `display:flex;align-items:center;gap:0.75rem;padding:0.65rem ${isMember ? '1.5rem' : '0.65rem'} 0.65rem;border-bottom:1px solid #f3f4f6;cursor:pointer;${isAssigned?'background:#f0fdf4;border-left:3px solid #10b981;':''}${isBusy?'background:#fffbeb;border-left:3px solid #f59e0b;':''}`;
                const cb = document.createElement('input');
                cb.type = 'checkbox'; cb.value = r.id; cb.checked = isAssigned; cb.disabled = isAssigned || isBusy;
                cb.id = 'vr-resp-' + r.id;
                cb.style.cssText = 'width:18px;height:18px;accent-color:#059669;';
                const busyLabel = isBusy ? ' <span style="font-size:0.75rem;color:#b45309;font-weight:600;">Has active assignment (finish first)</span>' : '';
                const info = document.createElement('div');
                info.innerHTML = `<div style="font-weight:500;font-size:0.875rem;color:${isAssigned?'#059669':isBusy?'#92400e':'#1f2937'};">${escapeHtml(r.name)}${isAssigned?' <span style="font-size:0.75rem;color:#059669;font-weight:600;">‚úì Assigned</span>':''}${busyLabel}</div><div style="font-size:0.75rem;color:#6b7280;">${escapeHtml((r.role||'responder') + (isMember ? ' (member)' : ' (leader)'))}</div>`;
                row.addEventListener('click', e => { if (e.target.type !== 'checkbox' && !cb.disabled) cb.checked = !cb.checked; });
                row.appendChild(cb); row.appendChild(info);
                return { row, cb };
            }

            teams.forEach(team => {
                const allIds = [team.leader.id, ...team.members.map(m => m.id)];
                const allAssigned = allIds.every(id => assignedIds.includes(id));
                const anyBusy = allIds.some(id => busyResponderIds.has(id));
                const teamHead = document.createElement('div');
                teamHead.style.cssText = 'display:flex;align-items:center;gap:0.5rem;margin:0.75rem 0 0.35rem;padding:0.4rem 0;border-bottom:1px solid #e5e7eb;';
                const teamCb = document.createElement('input');
                teamCb.type = 'checkbox';
                teamCb.checked = allAssigned;
                teamCb.disabled = allAssigned || anyBusy;
                teamCb.style.cssText = 'width:18px;height:18px;accent-color:#059669;';
                const teamLbl = document.createElement('span');
                teamLbl.style.cssText = 'font-weight:600;font-size:0.9rem;color:#374151;cursor:pointer;';
                teamLbl.textContent = team.name + ' (' + allIds.length + ') ‚Äì Assign whole team';
                teamLbl.addEventListener('click', () => { if (!teamCb.disabled) { teamCb.checked = !teamCb.checked; allIds.forEach(id => { const c = document.getElementById('vr-resp-' + id); if (c && !c.disabled) c.checked = teamCb.checked; }); } });
                teamCb.addEventListener('change', () => { allIds.forEach(id => { const c = document.getElementById('vr-resp-' + id); if (c && !c.disabled) c.checked = teamCb.checked; }); });
                teamHead.appendChild(teamCb); teamHead.appendChild(teamLbl);
                list.appendChild(teamHead);
                const leaderAssigned = assignedIds.includes(team.leader.id);
                const leaderBusy = busyResponderIds.has(team.leader.id);
                const { row: lRow, cb: lCb } = addRow(team.leader, leaderAssigned, leaderBusy, false);
                list.appendChild(lRow);
                team.members.forEach(m => { const ma = assignedIds.includes(m.id); const mb = busyResponderIds.has(m.id); list.appendChild(addRow(m, ma, mb, true).row); });
            });
            if (ungrouped.length) {
                const ugHead = document.createElement('div');
                ugHead.style.cssText = 'font-weight:600;font-size:0.9rem;color:#6b7280;margin:0.75rem 0 0.5rem;padding:0.4rem 0;border-bottom:1px solid #e5e7eb;';
                ugHead.textContent = 'Ungrouped';
                list.appendChild(ugHead);
                ungrouped.forEach(r => list.appendChild(addRow(r, assignedIds.includes(r.id), busyResponderIds.has(r.id), false).row));
            }
        } catch(e) { list.innerHTML = `<div style="padding:1rem;text-align:center;color:#ef4444;">Failed to load: ${e.message}</div>`; }
    }

    function closeAssignResponderModalVR() {
        document.getElementById('assignResponderModal').style.display = 'none';
    }

    async function confirmAssignResponderVR() {
        const checked = document.querySelectorAll('#vrResponderList input[type="checkbox"]:checked:not(:disabled)');
        let selectedIds = Array.from(checked).map(cb => cb.value);
        if (!selectedIds.length) { showToast('Please select at least one responder', 'error'); return; }
        const respondersList = window._lastAssignModalResponders || [];
        const expandedSet = new Set(selectedIds);
        selectedIds.forEach(leaderId => {
            respondersList.filter(r => r.leader_id === leaderId).forEach(m => expandedSet.add(m.id));
        });
        selectedIds = Array.from(expandedSet);
        try {
            const { data: existing } = await window.emergencySystem.supabase.from('assignment').select('responder_id').eq('report_id', currentReportId).eq('status','assigned');
            const existingIds = existing ? existing.map(a => a.responder_id) : [];
            const newIds = selectedIds.filter(id => !existingIds.includes(id));
            if (!newIds.length) { showToast('All selected responders are already assigned', 'info'); closeAssignResponderModalVR(); return; }
            // Block assigning responders who already have an active assignment (must finish first)
            const { data: allAssignmentsForResponders } = await window.emergencySystem.supabase.from('assignment').select('responder_id, status').in('responder_id', newIds);
            const activeStatuses = ['assigned', 'accepted', 'enroute', 'in_progress', 'on_scene'];
            const busyResponderIds = [...new Set((allAssignmentsForResponders || []).filter(a => activeStatuses.includes(a.status)).map(a => a.responder_id))];
            if (busyResponderIds.length > 0) {
                const respondersList = window._lastAssignModalResponders || [];
                const names = busyResponderIds.map(id => { const r = respondersList.find(x => x.id === id); return r ? (r.name || r.email || id) : id; }).join(', ');
                showToast('Cannot assign: these responder(s) already have an active assignment and must finish it first: ' + names, 'error');
                return;
            }
            const { error } = await window.emergencySystem.supabase.from('assignment').insert(newIds.map(id => ({ report_id: currentReportId, responder_id: id, status: 'assigned' })));
            if (error) throw error;
            await window.emergencySystem.supabase.from('reports').update({ status: 'assigned', last_update: new Date().toISOString() }).eq('id', currentReportId).neq('status','completed');
            showToast(`${newIds.length} responder(s) assigned successfully!`, 'success');
            closeAssignResponderModalVR();
            await loadReports();
            if (!document.getElementById('viewReportModal').classList.contains('hidden')) {
                await viewReport(currentReportId);
            }
        } catch(e) { showToast('Failed to assign: ' + e.message, 'error'); }
    }

    function editReport(reportId) {
        openEditModal(reportId);
    }

    async function archiveReport(reportId) {
        if (!confirm('Are you sure you want to archive this report?')) return;
        try {
            await window.emergencySystem.archiveReport(reportId);
            await loadReports();
        } catch (error) {
            alert('Failed to archive report: ' + error.message);
        }
    }

    async function deleteReport(reportId) {
        if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) return;
        try {
            await window.emergencySystem.deleteReport(reportId);
            await loadReports();
        } catch (error) {
            alert('Failed to delete report: ' + error.message);
        }
    }

    // ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function exportReports() {
        const csvContent = generateCSV(filteredReports);
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `emergency-reports-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function generateCSV(reports) {
        const headers = ['ID', 'Type', 'Reporter', 'Location', 'Status', 'Priority', 'Created', 'Message'];
        const rows = reports.map(report => [
            report.id || 'N/A',
            report.type || 'other',
            report.reporter_name || 'Anonymous',
            report.location?.address || 'Location detected',
            report.status || 'pending',
            getPriorityText(report.priority || 4),
            report.created_at ? new Date(report.created_at).toLocaleString() : 'N/A',
            report.message || ''
        ]);
        return [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
    }

    // ‚îÄ‚îÄ Pagination ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updatePagination() {
        const totalPages = Math.ceil(filteredReports.length / reportsPerPage);
        const start = (currentPage - 1) * reportsPerPage + 1;
        const end = Math.min(currentPage * reportsPerPage, filteredReports.length);

        document.getElementById('showingFrom').textContent = filteredReports.length ? start : 0;
        document.getElementById('showingTo').textContent = filteredReports.length ? end : 0;
        document.getElementById('totalReports').textContent = filteredReports.length;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages || !totalPages;

        const pageNumbers = document.getElementById('pageNumbers');
        pageNumbers.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = `page-number ${i === currentPage ? 'active' : ''}`;
            btn.onclick = () => goToPage(i);
            pageNumbers.appendChild(btn);
        }
    }

    function goToPage(page) { currentPage = page; displayReports(); updatePagination(); }
    function previousPage() { if (currentPage > 1) { currentPage--; displayReports(); updatePagination(); } }
    function nextPage() { const tp = Math.ceil(filteredReports.length / reportsPerPage); if (currentPage < tp) { currentPage++; displayReports(); updatePagination(); } }

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getEmergencyIcon(type) {
        const icons = { fire:'üî•', flood:'üåä', accident:'üöó', medical:'üè•', earthquake:'üåç', storm:'‚õàÔ∏è', false_alarm:'üö´', other:'‚ö†Ô∏è' };
        return icons[type || 'other'] || '‚ö†Ô∏è';
    }

    function getPriorityText(priority) {
        return { 1:'Critical', 2:'High', 3:'Medium', 4:'Low' }[priority] || 'Low';
    }

    function showLoadingIndicator() {
        const tbody = document.getElementById('reportsTableBody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8"><div class="loading-spinner"></div><p>Loading reports...</p></td></tr>';
    }

    function hideLoadingIndicator() {}

    // ‚îÄ‚îÄ Classification Correction ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function openCorrectionModalFromId(reportId) {
        try {
            const supabaseClient = window.emergencySystem?.supabase || window.supabase;
            if (!supabaseClient) { showToast('Supabase client not initialized.', 'error'); return; }
            const { data: report, error } = await supabaseClient.from('reports').select('*').eq('id', reportId).single();
            if (error) { showToast('Failed to load report: ' + error.message, 'error'); return; }
            if (report) openCorrectionModal(reportId, report);
            else showToast('Report not found', 'error');
        } catch (e) {
            showToast('Failed to open correction form: ' + e.message, 'error');
        }
    }

    function openCorrectionModal(reportId, reportData) {
        currentReportForCorrection = { id: reportId, ...reportData };
        document.getElementById('correction-modal').classList.remove('hidden');
        document.getElementById('current-type').textContent = (reportData.type || 'unknown').toUpperCase();
        document.getElementById('current-confidence').textContent = reportData.confidence ? `${(reportData.confidence * 100).toFixed(0)}%` : 'N/A';
        const aiInfo = document.getElementById('ai-analysis-info');
        if (reportData.ai_description || reportData.ai_labels) {
            let aiText = '';
            if (reportData.ai_description) aiText += `<strong>Description:</strong> ${reportData.ai_description}<br>`;
            if (reportData.ai_labels && Array.isArray(reportData.ai_labels)) aiText += `<strong>Tags:</strong> ${reportData.ai_labels.join(', ')}`;
            aiInfo.innerHTML = aiText || 'No AI analysis available';
        } else {
            aiInfo.textContent = 'No AI analysis available';
        }
        document.getElementById('corrected-type').value = '';
        document.getElementById('corrected-description').value = '';
        document.getElementById('correction-reason').value = '';
        document.querySelectorAll('input[type="checkbox"][name="issue-category"]').forEach(cb => cb.checked = false);
    }

    function closeCorrectionModal() {
        document.getElementById('correction-modal').classList.add('hidden');
        currentReportForCorrection = null;
    }

    async function submitCorrection() {
        const reportId = currentReportForCorrection?.id;
        if (!reportId) { showToast('No report selected', 'error'); return; }

        const correctedType = document.getElementById('corrected-type').value;
        const correctedDescription = document.getElementById('corrected-description').value.trim();
        const correctionReason = document.getElementById('correction-reason').value;
        const issueCategories = Array.from(document.querySelectorAll('input[type="checkbox"][name="issue-category"]:checked')).map(cb => cb.value);

        if (!correctedType) { showToast('Please select the correct emergency type', 'warning'); return; }
        if (!correctionReason || correctionReason.trim().length < 20) { showToast('Please provide a detailed correction reason (minimum 20 characters)', 'warning'); return; }

        const submitBtn = document.querySelector('#correction-modal button[type="submit"]');
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Submitting...'; }

        try {
            const supabaseClient = window.emergencySystem?.supabase || window.supabase;
            if (!supabaseClient) { showToast('Supabase client not initialized.', 'error'); return; }

            let { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                const { data: { session: refreshed } } = await supabaseClient.auth.refreshSession();
                session = refreshed;
            }
            if (!session) { showToast('You must be logged in. Please log in again.', 'error'); return; }

            const supabaseUrl = window.EMERGENCY_CONFIG?.supabaseUrl || 'https://hmolyqzbvxxliemclrld.supabase.co';
            const response = await fetch(`${supabaseUrl}/functions/v1/correct-classification`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${session.access_token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ report_id: reportId, corrected_type: correctedType, corrected_description: correctedDescription || undefined, correction_reason: correctionReason.trim(), issue_categories: issueCategories, correction_confidence: true })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('Classification corrected successfully!', 'success');
                closeCorrectionModal();
                loadReports();
            } else {
                showToast('Failed: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            showToast('Failed to submit correction. Please try again.', 'error');
        } finally {
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit Correction'; }
        }
    }

    // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showLogoutConfirm() { document.getElementById('logoutModal').classList.remove('hidden'); }
    function closeLogoutModal() { document.getElementById('logoutModal').classList.add('hidden'); }
    async function confirmLogout() {
        try {
            closeLogoutModal();
            await window.emergencySystem.signOut();
            window.location.href = 'login.html';
        } catch (error) {
            alert('Failed to logout. Please try again.');
        }
    }

    document.addEventListener('click', function (event) {
        const lm = document.getElementById('logoutModal');
        const cm = document.getElementById('correction-modal');
        const vm = document.getElementById('viewReportModal');
        const am = document.getElementById('assignResponderModal');
        const em = document.getElementById('editReportModal');
        if (event.target === lm) closeLogoutModal();
        if (event.target === cm) closeCorrectionModal();
        if (event.target === vm) closeViewModal();
        if (event.target === am) closeAssignResponderModalVR();
        if (event.target === em) closeEditModal();
    });

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeLogoutModal();
            closeCorrectionModal();
            closeViewModal();
            closeAssignResponderModalVR();
            closeEditModal();
        }
    });
</script>
</body>
</html>
